<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sensor Data Dashboard</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .sensor-panel {
        transition: all 0.3s ease;
      }
      .sensor-panel:hover {
        transform: translateY(-2px);
      }
      .pulse {
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      function SensorPanel({ title, sensorType, data, color }) {
        const [isConnected, setIsConnected] = useState(false);

        useEffect(() => {
          setIsConnected(data !== null);
        }, [data]);

        const getStatusColor = () => {
          if (!isConnected) return "bg-gray-400";
          return color;
        };

        const formatTimestamp = (timestamp) => {
          if (!timestamp) return "No data";
          return new Date(timestamp).toLocaleTimeString();
        };

        const getDisplayValue = () => {
          if (!data || !data.value) return "No data";
          return data.value;
        };

        return (
          <div
            className={`sensor-panel bg-white rounded-lg shadow-lg p-6 ${
              isConnected ? "border-l-4" : "border-l-4 border-gray-300"
            }`}
            style={{
              borderLeftColor: isConnected
                ? color.replace("bg-", "#")
                : "#d1d5db",
            }}
          >
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-xl font-bold text-gray-800">{title}</h2>
              <div
                className={`w-3 h-3 rounded-full ${
                  isConnected ? "bg-green-500 pulse" : "bg-red-500"
                }`}
              ></div>
            </div>

            <div className="mb-4">
              <div
                className={`text-3xl font-bold text-center py-4 rounded-lg ${getStatusColor()} text-white`}
              >
                {getDisplayValue()}
              </div>
            </div>

            <div className="text-sm text-gray-600">
              <div className="flex justify-between">
                <span>Status:</span>
                <span
                  className={`font-medium ${
                    isConnected ? "text-green-600" : "text-red-600"
                  }`}
                >
                  {isConnected ? "Connected" : "Disconnected"}
                </span>
              </div>
              <div className="flex justify-between mt-1">
                <span>Last Update:</span>
                <span>{formatTimestamp(data?.timestamp)}</span>
              </div>
              {data?.operator_name && (
                <div className="flex justify-between mt-1">
                  <span>Operator:</span>
                  <span>{data.operator_name}</span>
                </div>
              )}
            </div>
          </div>
        );
      }

      function Dashboard() {
        const [sensorData, setSensorData] = useState({
          emotion: null,
          gaze: null,
          stress: null,
        });
        const [connectionStatus, setConnectionStatus] =
          useState("Disconnected");
        const [socket, setSocket] = useState(null);

        useEffect(() => {
          // Initialize socket connection
          const newSocket = io("http://localhost:3000");
          setSocket(newSocket);

          newSocket.on("connect", () => {
            console.log("Connected to server");
            setConnectionStatus("Connected");
          });

          newSocket.on("disconnect", () => {
            console.log("Disconnected from server");
            setConnectionStatus("Disconnected");
          });

          newSocket.on("latest-data", (data) => {
            console.log("Received latest data:", data);
            setSensorData(data);
          });

          newSocket.on("sensor-update", (update) => {
            console.log("Received sensor update:", update);
            setSensorData((prev) => ({
              ...prev,
              [update.sensor_type]: update.data,
            }));
          });

          newSocket.on("connect_error", (error) => {
            console.error("Connection error:", error);
            setConnectionStatus("Connection Error");
          });

          // Cleanup on unmount
          return () => {
            newSocket.close();
          };
        }, []);

        const getConnectionStatusColor = () => {
          switch (connectionStatus) {
            case "Connected":
              return "text-green-600";
            case "Disconnected":
              return "text-red-600";
            default:
              return "text-yellow-600";
          }
        };

        return (
          <div className="min-h-screen bg-gray-100 p-6">
            <div className="max-w-7xl mx-auto">
              {/* Header */}
              <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div className="flex items-center justify-between">
                  <h1 className="text-3xl font-bold text-gray-800">
                    Sensor Data Dashboard
                  </h1>
                  <div className="text-right">
                    <div
                      className={`text-lg font-medium ${getConnectionStatusColor()}`}
                    >
                      {connectionStatus}
                    </div>
                    <div className="text-sm text-gray-600">
                      {new Date().toLocaleString()}
                    </div>
                  </div>
                </div>
              </div>

              {/* Sensor Panels */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <SensorPanel
                  title="Emotion Detection"
                  sensorType="emotion"
                  data={sensorData.emotion}
                  color="bg-blue-500"
                />
                <SensorPanel
                  title="Gaze Tracking"
                  sensorType="gaze"
                  data={sensorData.gaze}
                  color="bg-green-500"
                />
                <SensorPanel
                  title="Stress Detection"
                  sensorType="stress"
                  data={sensorData.stress}
                  color="bg-red-500"
                />
              </div>

              {/* Instructions */}
              <div className="bg-white rounded-lg shadow-lg p-6 mt-6">
                <h2 className="text-xl font-bold text-gray-800 mb-4">
                  Instructions
                </h2>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-gray-600">
                  <div>
                    <h3 className="font-medium text-blue-600 mb-2">
                      Emotion Detection
                    </h3>
                    <p>
                      Run:{" "}
                      <code className="bg-gray-100 px-2 py-1 rounded">
                        python emotion_sensor.py
                      </code>
                    </p>
                    <p>Detects facial emotions in real-time</p>
                  </div>
                  <div>
                    <h3 className="font-medium text-green-600 mb-2">
                      Gaze Tracking
                    </h3>
                    <p>
                      Run:{" "}
                      <code className="bg-gray-100 px-2 py-1 rounded">
                        python gaze_sensor.py
                      </code>
                    </p>
                    <p>Tracks eye movement and blink detection</p>
                  </div>
                  <div>
                    <h3 className="font-medium text-red-600 mb-2">
                      Stress Detection
                    </h3>
                    <p>
                      Run:{" "}
                      <code className="bg-gray-100 px-2 py-1 rounded">
                        python stress_sensor.py
                      </code>
                    </p>
                    <p>Monitors stress levels based on emotions</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      ReactDOM.render(<Dashboard />, document.getElementById("root"));
    </script>
  </body>
</html>
